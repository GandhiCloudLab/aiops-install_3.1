# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Install Script for Turbonomic
#
# V3.1 
#
# ©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./99_config-global.sh

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

#headerModuleFileBegin "Install Turbonomic " $0

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# INSTALL CHECKS
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
header3Begin "Install Turbonomic"


        getInstallPath

        BASE_DN="dc="$(echo $LDAP_DOMAIN | ${SED} -e "s/\./,dc=/")
        BIND_DN="cn=admin,"$BASE_DN


        checkAlreadyInstalled app=Turbonomic default
        if [[ $ALREADY_INSTALLED == 1 ]];
        then
            __output "    ⭕ Turbonomic already installed! Skipping..."

            #headerModuleFileEnd "Install Open LDAP " $0
            exit 0
        else
            __output "      ✅ OK"
        fi

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PREREQUISITES
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Running Prerequisites" "rocket"

        export SCRIPT_PATH=$(pwd)
        __output "      ✅ OK"

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Klusterlet
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Install Turbonomic" "rocket"


      __output "Install Turbonomic Helm Chart"

      oc create ns turbonomic
      oc adm policy add-scc-to-group anyuid system:serviceaccounts:turbonomic
oc create -f ./yaml/turbonomic/service_account.yaml -n turbonomic
oc create -f ./yaml/turbonomic/role.yaml -n turbonomic
oc create -f ./yaml/turbonomic/role_binding.yaml -n turbonomic
oc create -f ./yaml/turbonomic/charts_v1alpha1_xl_crd.yaml
oc create -f ./yaml/turbonomic/operator.yaml -n turbonomic

oc apply -f ./yaml/turbonomic/turbonomic_cr.yaml -n turbonomic
oc create route turbo -n turbonomic --service=ui --port=http-ui


        __output "      ✅ Turbonomic Installed"
header3End

      oc adm policy add-scc-to-group anyuid system:serviceaccount:turbonomic:t8c-operator

oc create clusterrolebinding test-admin --clusterrole=cluster-admin --serviceaccount=turbonomic:t8c-operator
oc adm policy add-role-to-user cluster-admin system:serviceaccount:turbonomic:t8c-operator --role-namespace=turbonomic -n turbonomic

#headerModuleFileEnd "Install Turbonomic " $0

exit 1
oc delete -f ./yaml/turbonomic/turbonomic_cr.yaml -n turbonomic

oc delete -f ./yaml/turbonomic/service_account.yaml -n turbonomic
oc delete -f ./yaml/turbonomic/role.yaml -n turbonomic
oc delete -f ./yaml/turbonomic/role_binding.yaml -n turbonomic
oc delete -f ./yaml/turbonomic/charts_v1alpha1_xl_crd.yaml
oc delete -f ./yaml/turbonomic/operator.yaml -n turbonomic
oc delete ns turbonomic